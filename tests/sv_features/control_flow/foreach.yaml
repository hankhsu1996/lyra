feature: foreach_loops
description: Tests for foreach array iteration loops

cases:
  # Basic 1D unpacked array
  - name: foreach_basic_sum
    sv: |
      module Test;
        int sum;
        initial begin
          int arr[4];
          arr[0] = 1;
          arr[1] = 2;
          arr[2] = 3;
          arr[3] = 4;
          sum = 0;
          foreach (arr[i]) begin
            sum = sum + arr[i];
          end
        end
      endmodule
    expect:
      variables:
        sum: 10

  - name: foreach_iteration_order
    sv: |
      module Test;
        int first_idx;
        int last_idx;
        initial begin
          int arr[3];
          arr[0] = 10;
          arr[1] = 20;
          arr[2] = 30;
          first_idx = -1;
          last_idx = -1;
          foreach (arr[i]) begin
            if (first_idx == -1) first_idx = i;
            last_idx = i;
          end
        end
      endmodule
    expect:
      variables:
        first_idx: 0
        last_idx: 2

  - name: foreach_index_as_value
    sv: |
      module Test;
        int sum;
        initial begin
          int arr[5];
          sum = 0;
          foreach (arr[i]) begin
            sum = sum + i;
          end
        end
      endmodule
    expect:
      variables:
        sum: 10

  - name: foreach_non_zero_base
    sv: |
      module Test;
        int sum;
        int first_idx;
        int last_idx;
        initial begin
          int arr[2:4];
          arr[2] = 10;
          arr[3] = 20;
          arr[4] = 30;
          sum = 0;
          first_idx = -1;
          last_idx = -1;
          foreach (arr[i]) begin
            if (first_idx == -1) first_idx = i;
            last_idx = i;
            sum = sum + arr[i];
          end
        end
      endmodule
    expect:
      variables:
        sum: 60
        first_idx: 2
        last_idx: 4

  # Packed array with descending range
  - name: foreach_packed_descending
    sv: |
      module Test;
        int first_idx;
        int last_idx;
        int count;
        initial begin
          bit [3:0] data;
          data = 4'b1010;
          first_idx = -1;
          last_idx = -1;
          count = 0;
          foreach (data[i]) begin
            if (first_idx == -1) first_idx = i;
            last_idx = i;
            if (data[i]) count = count + 1;
          end
        end
      endmodule
    expect:
      variables:
        first_idx: 3
        last_idx: 0
        count: 2

  # Break and continue
  - name: foreach_with_break
    sv: |
      module Test;
        int sum;
        int stopped_at;
        initial begin
          int arr[5];
          arr[0] = 1;
          arr[1] = 2;
          arr[2] = 3;
          arr[3] = 4;
          arr[4] = 5;
          sum = 0;
          stopped_at = -1;
          foreach (arr[i]) begin
            if (i == 3) break;
            sum = sum + arr[i];
            stopped_at = i;
          end
        end
      endmodule
    expect:
      variables:
        sum: 6
        stopped_at: 2

  - name: foreach_with_continue
    sv: |
      module Test;
        int sum;
        initial begin
          int arr[5];
          arr[0] = 1;
          arr[1] = 2;
          arr[2] = 3;
          arr[3] = 4;
          arr[4] = 5;
          sum = 0;
          foreach (arr[i]) begin
            if (i == 1 || i == 3) continue;
            sum = sum + arr[i];
          end
        end
      endmodule
    expect:
      variables:
        sum: 9

  # Nested with for loop
  - name: foreach_nested_with_for
    sv: |
      module Test;
        int total;
        initial begin
          int matrix[2];
          matrix[0] = 10;
          matrix[1] = 20;
          total = 0;
          foreach (matrix[i]) begin
            for (int j = 0; j < 2; j++) begin
              total = total + matrix[i];
            end
          end
        end
      endmodule
    expect:
      variables:
        total: 60

  # Display index and value
  - name: foreach_display
    sv: |
      module Test;
        initial begin
          int arr[3];
          arr[0] = 100;
          arr[1] = 200;
          arr[2] = 300;
          foreach (arr[i]) begin
            $display("arr[%0d] = %0d", i, arr[i]);
          end
        end
      endmodule
    expect:
      stdout: |
        arr[0] = 100
        arr[1] = 200
        arr[2] = 300

  # ============================================
  # Multi-dimensional foreach tests
  # ============================================

  - name: foreach_2d_basic
    sv: |
      module Test;
        int sum;
        initial begin
          int arr[2][3];
          arr[0][0] = 1; arr[0][1] = 2; arr[0][2] = 3;
          arr[1][0] = 4; arr[1][1] = 5; arr[1][2] = 6;
          sum = 0;
          foreach (arr[i,j]) begin
            sum = sum + arr[i][j];
          end
        end
      endmodule
    expect:
      variables:
        sum: 21

  - name: foreach_2d_iteration_order
    description: Verify outer dimension iterates first (i changes slower than j)
    sv: |
      module Test;
        int order;
        initial begin
          int arr[2][3];
          order = 0;
          foreach (arr[i,j]) begin
            // Build number: each iteration adds i*10 + j
            // Sequence: (0,0)->(0,1)->(0,2)->(1,0)->(1,1)->(1,2)
            // Values:   00    01     02     10     11     12
            order = order * 100 + i * 10 + j;
          end
        end
      endmodule
    expect:
      variables:
        order: 102101112

  - name: foreach_2d_index_values
    sv: |
      module Test;
        int first_i, first_j;
        int last_i, last_j;
        initial begin
          int arr[3][4];
          first_i = -1;
          first_j = -1;
          last_i = -1;
          last_j = -1;
          foreach (arr[i,j]) begin
            if (first_i == -1) begin
              first_i = i;
              first_j = j;
            end
            last_i = i;
            last_j = j;
          end
        end
      endmodule
    expect:
      variables:
        first_i: 0
        first_j: 0
        last_i: 2
        last_j: 3

  - name: foreach_2d_non_zero_base
    sv: |
      module Test;
        int sum_i, sum_j;
        initial begin
          int arr[1:2][3:5];
          sum_i = 0;
          sum_j = 0;
          foreach (arr[i,j]) begin
            sum_i = sum_i + i;
            sum_j = sum_j + j;
          end
        end
      endmodule
    expect:
      variables:
        sum_i: 9
        sum_j: 24

  - name: foreach_3d_basic
    sv: |
      module Test;
        int count;
        initial begin
          int arr[2][3][4];
          count = 0;
          foreach (arr[i,j,k]) begin
            count = count + 1;
          end
        end
      endmodule
    expect:
      variables:
        count: 24

  - name: foreach_2d_with_break
    sv: |
      module Test;
        int sum;
        int stopped_i, stopped_j;
        initial begin
          int arr[3][3];
          int val;
          val = 1;
          for (int r = 0; r < 3; r++)
            for (int c = 0; c < 3; c++) begin
              arr[r][c] = val;
              val = val + 1;
            end
          // arr is now: 1 2 3 / 4 5 6 / 7 8 9
          sum = 0;
          stopped_i = -1;
          stopped_j = -1;
          foreach (arr[i,j]) begin
            if (arr[i][j] > 5) break;
            sum = sum + arr[i][j];
            stopped_i = i;
            stopped_j = j;
          end
        end
      endmodule
    expect:
      variables:
        sum: 15
        stopped_i: 1
        stopped_j: 1

  - name: foreach_2d_with_continue
    sv: |
      module Test;
        int sum;
        initial begin
          int arr[2][3];
          arr[0][0] = 1; arr[0][1] = 2; arr[0][2] = 3;
          arr[1][0] = 4; arr[1][1] = 5; arr[1][2] = 6;
          sum = 0;
          foreach (arr[i,j]) begin
            if (j == 1) continue;
            sum = sum + arr[i][j];
          end
        end
      endmodule
    expect:
      variables:
        sum: 14

  - name: foreach_2d_descending_range
    sv: |
      module Test;
        int first_i, first_j;
        int last_i, last_j;
        initial begin
          int arr[3:1][5:3];
          first_i = -1;
          first_j = -1;
          last_i = -1;
          last_j = -1;
          foreach (arr[i,j]) begin
            if (first_i == -1) begin
              first_i = i;
              first_j = j;
            end
            last_i = i;
            last_j = j;
          end
        end
      endmodule
    expect:
      variables:
        first_i: 3
        first_j: 5
        last_i: 1
        last_j: 3

  - name: foreach_3d_iteration_order
    description: Verify 3D iteration order (i slowest, k fastest)
    sv: |
      module Test;
        int first_i;
        int first_j;
        int first_k;
        int last_i;
        int last_j;
        int last_k;
        initial begin
          int arr[2][2][3];
          first_i = -1;
          first_j = -1;
          first_k = -1;
          last_i = -1;
          last_j = -1;
          last_k = -1;
          foreach (arr[i,j,k]) begin
            if (first_i == -1) begin
              first_i = i;
              first_j = j;
              first_k = k;
            end
            last_i = i;
            last_j = j;
            last_k = k;
          end
        end
      endmodule
    expect:
      variables:
        first_i: 0
        first_j: 0
        first_k: 0
        last_i: 1
        last_j: 1
        last_k: 2

  - name: foreach_2d_mixed_direction
    description: First dimension ascending, second descending
    sv: |
      module Test;
        int first_i, first_j;
        int last_i, last_j;
        initial begin
          int arr[0:2][5:3];
          first_i = -1;
          first_j = -1;
          foreach (arr[i,j]) begin
            if (first_i == -1) begin
              first_i = i;
              first_j = j;
            end
            last_i = i;
            last_j = j;
          end
        end
      endmodule
    expect:
      variables:
        first_i: 0
        first_j: 5
        last_i: 2
        last_j: 3

  - name: foreach_2d_single_element_dim
    description: Dimension with only one element
    sv: |
      module Test;
        int count;
        int captured_j;
        initial begin
          int arr[3][5:5];
          count = 0;
          captured_j = -1;
          foreach (arr[i,j]) begin
            count = count + 1;
            captured_j = j;
          end
        end
      endmodule
    expect:
      variables:
        count: 3
        captured_j: 5

  # ============================================
  # Skipped dimension tests
  # ============================================

  - name: foreach_skip_middle_dim
    description: Skip middle dimension with foreach(arr[i,,k])
    sv: |
      module Test;
        int count;
        int first_i;
        int first_k;
        int last_i;
        int last_k;
        initial begin
          int arr[2][3][4];
          count = 0;
          first_i = -1;
          first_k = -1;
          foreach (arr[i,,k]) begin
            if (first_i == -1) begin
              first_i = i;
              first_k = k;
            end
            last_i = i;
            last_k = k;
            count = count + 1;
          end
        end
      endmodule
    expect:
      variables:
        count: 8
        first_i: 0
        first_k: 0
        last_i: 1
        last_k: 3

  - name: foreach_skip_first_dim
    description: Skip first dimension with foreach(arr[,j,k])
    sv: |
      module Test;
        int count;
        int first_j;
        int first_k;
        initial begin
          int arr[2][3][4];
          count = 0;
          first_j = -1;
          first_k = -1;
          foreach (arr[,j,k]) begin
            if (first_j == -1) begin
              first_j = j;
              first_k = k;
            end
            count = count + 1;
          end
        end
      endmodule
    expect:
      variables:
        count: 12
        first_j: 0
        first_k: 0

  - name: foreach_skip_trailing_dims
    description: Only iterate first dimension (trailing dims omitted)
    sv: |
      module Test;
        int count;
        int sum_i;
        initial begin
          int arr[3][4][5];
          count = 0;
          sum_i = 0;
          foreach (arr[i]) begin
            sum_i = sum_i + i;
            count = count + 1;
          end
        end
      endmodule
    expect:
      variables:
        count: 3
        sum_i: 3

  - name: foreach_skip_multiple_dims
    description: Skip first and last dimensions
    sv: |
      module Test;
        int count;
        int sum_j;
        initial begin
          int arr[2][3][4];
          count = 0;
          sum_j = 0;
          foreach (arr[,j]) begin
            sum_j = sum_j + j;
            count = count + 1;
          end
        end
      endmodule
    expect:
      variables:
        count: 3
        sum_j: 3

  - name: foreach_dynamic_array_basic
    description: Basic foreach over dynamic array
    sv: |
      module Test;
        int sum;
        initial begin
          int arr[];
          arr = new[4];
          arr[0] = 1;
          arr[1] = 2;
          arr[2] = 3;
          arr[3] = 4;
          sum = 0;
          foreach (arr[i]) begin
            sum = sum + arr[i];
          end
        end
      endmodule
    expect:
      variables:
        sum: 10

  - name: foreach_dynamic_array_iteration_order
    description: Verify dynamic array iterates 0 to size-1
    sv: |
      module Test;
        int first_idx;
        int last_idx;
        initial begin
          int arr[];
          arr = new[5];
          first_idx = -1;
          last_idx = -1;
          foreach (arr[i]) begin
            if (first_idx == -1) first_idx = i;
            last_idx = i;
          end
        end
      endmodule
    expect:
      variables:
        first_idx: 0
        last_idx: 4

  - name: foreach_dynamic_array_empty
    description: Foreach over empty dynamic array (no iterations)
    sv: |
      module Test;
        int count;
        initial begin
          int arr[];
          count = 0;
          foreach (arr[i]) begin
            count = count + 1;
          end
        end
      endmodule
    expect:
      variables:
        count: 0

  - name: foreach_dynamic_array_with_break
    description: Break inside dynamic array foreach
    sv: |
      module Test;
        int sum;
        int stopped_at;
        initial begin
          int arr[];
          arr = new[5];
          arr[0] = 1;
          arr[1] = 2;
          arr[2] = 3;
          arr[3] = 4;
          arr[4] = 5;
          sum = 0;
          stopped_at = -1;
          foreach (arr[i]) begin
            if (i == 3) break;
            sum = sum + arr[i];
            stopped_at = i;
          end
        end
      endmodule
    expect:
      variables:
        sum: 6
        stopped_at: 2

  - name: foreach_dynamic_array_with_continue
    description: Continue inside dynamic array foreach
    sv: |
      module Test;
        int sum;
        initial begin
          int arr[];
          arr = new[5];
          arr[0] = 1;
          arr[1] = 2;
          arr[2] = 3;
          arr[3] = 4;
          arr[4] = 5;
          sum = 0;
          foreach (arr[i]) begin
            if (i == 1 || i == 3) continue;
            sum = sum + arr[i];
          end
        end
      endmodule
    expect:
      variables:
        sum: 9

  - name: foreach_queue_basic
    description: Basic foreach over queue
    sv: |
      module Test;
        int sum;
        initial begin
          int q[$];
          q.push_back(10);
          q.push_back(20);
          q.push_back(30);
          sum = 0;
          foreach (q[i]) begin
            sum = sum + q[i];
          end
        end
      endmodule
    expect:
      variables:
        sum: 60

  - name: foreach_queue_iteration_order
    description: Verify queue iterates 0 to size-1
    sv: |
      module Test;
        int first_idx;
        int last_idx;
        initial begin
          int q[$];
          q.push_back(1);
          q.push_back(2);
          q.push_back(3);
          first_idx = -1;
          last_idx = -1;
          foreach (q[i]) begin
            if (first_idx == -1) first_idx = i;
            last_idx = i;
          end
        end
      endmodule
    expect:
      variables:
        first_idx: 0
        last_idx: 2

  - name: foreach_queue_empty
    description: Foreach over empty queue (no iterations)
    sv: |
      module Test;
        int count;
        initial begin
          int q[$];
          count = 0;
          foreach (q[i]) begin
            count = count + 1;
          end
        end
      endmodule
    expect:
      variables:
        count: 0

  - name: foreach_skip_dim_access_subarray
    description: Access partial array with skipped dimension
    sv: |
      module Test;
        int sum;
        initial begin
          int arr[2][3];
          arr[0][0] = 1; arr[0][1] = 2; arr[0][2] = 3;
          arr[1][0] = 4; arr[1][1] = 5; arr[1][2] = 6;
          sum = 0;
          foreach (arr[i]) begin
            // arr[i] is a 1D array of size 3
            // Access first element of each subarray
            sum = sum + arr[i][0];
          end
        end
      endmodule
    expect:
      variables:
        sum: 5

  - name: foreach_skip_middle_access_outer
    description: Access outer array element with middle dim skipped
    sv: |
      module Test;
        int sum_first_elem;
        initial begin
          int arr[2][3][4];
          // Initialize first element of each 2D subarray
          arr[0][0][0] = 10;
          arr[1][0][0] = 20;
          sum_first_elem = 0;
          foreach (arr[i,,k]) begin
            // Access arr[i] (a 2D array) - get element [0][k]
            if (k == 0) begin
              sum_first_elem = sum_first_elem + arr[i][0][0];
            end
          end
        end
      endmodule
    expect:
      variables:
        sum_first_elem: 30

  - name: foreach_negative_indices
    description: Foreach with negative array bounds
    sv: |
      module Test;
        int sum_idx;
        int sum_val;
        initial begin
          int arr[-2:1];
          arr[-2] = 10;
          arr[-1] = 20;
          arr[0] = 30;
          arr[1] = 40;
          sum_idx = 0;
          sum_val = 0;
          foreach (arr[i]) begin
            sum_idx = sum_idx + i;
            sum_val = sum_val + arr[i];
          end
        end
      endmodule
    expect:
      variables:
        sum_idx: -2
        sum_val: 100
