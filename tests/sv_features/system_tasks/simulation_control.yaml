feature: simulation_control
description: Tests for simulation control system tasks ($finish, $stop, $exit)

cases:
  # $finish tests
  - name: finish_terminates
    sv: |
      module Test;
        int x;
        initial begin
          x = 1;
          $finish;
          x = 2;  // Should not execute
        end
      endmodule
    expect:
      variables:
        x: 1

  - name: finish_with_arg_0
    sv: |
      module Test;
        int x;
        initial begin
          x = 42;
          $finish(0);  // Level 0: no output
        end
      endmodule
    expect:
      variables:
        x: 42
      stdout: ""

  - name: finish_with_arg_1
    sv: |
      module Test;
        int x;
        initial begin
          x = 10;
          $finish(1);  // Level 1: print time (default)
        end
      endmodule
    expect:
      variables:
        x: 10
      stdout:
        contains:
          - "$finish called at time 0"

  - name: finish_default_level
    sv: |
      module Test;
        int x;
        initial begin
          x = 5;
          $finish;  // Default level is 1
        end
      endmodule
    expect:
      variables:
        x: 5
      stdout:
        contains:
          - "$finish called at time 0"

  - name: finish_after_delay
    sv: |
      module Test;
        int x;
        initial begin
          x = 0;
          #100;
          x = 1;
          $finish(1);
        end
      endmodule
    expect:
      variables:
        x: 1
      stdout:
        contains:
          - "$finish called at time 100"

  # $stop tests
  - name: stop_terminates
    sv: |
      module Test;
        int x;
        initial begin
          x = 1;
          $stop;
          x = 2;  // Should not execute
        end
      endmodule
    expect:
      variables:
        x: 1

  - name: stop_prints_message
    sv: |
      module Test;
        int x;
        initial begin
          x = 99;
          $stop(1);  // Level 1: print time and $stop message
        end
      endmodule
    expect:
      variables:
        x: 99
      stdout:
        contains:
          - "$stop called at time 0"

  - name: stop_with_arg_0
    sv: |
      module Test;
        int x;
        initial begin
          x = 7;
          $stop(0);  // Level 0: no output
        end
      endmodule
    expect:
      variables:
        x: 7
      stdout: ""

  - name: stop_after_delay
    sv: |
      module Test;
        int x;
        initial begin
          x = 0;
          #50;
          x = 1;
          $stop(1);
        end
      endmodule
    expect:
      variables:
        x: 1
      stdout:
        contains:
          - "$stop called at time 50"

  # $exit tests
  - name: exit_terminates
    sv: |
      module Test;
        int x;
        initial begin
          x = 1;
          $exit;
          x = 2;  // Should not execute
        end
      endmodule
    expect:
      variables:
        x: 1

  - name: exit_prints_time
    sv: |
      module Test;
        int x;
        initial begin
          x = 33;
          $exit;  // $exit always uses level 1
        end
      endmodule
    expect:
      variables:
        x: 33
      stdout:
        contains:
          - "$exit called at time 0"

  # Combined tests
  - name: finish_in_forever_loop
    sv: |
      module Test;
        int counter;
        initial begin
          counter = 0;
          forever begin
            counter = counter + 1;
            if (counter >= 5) $finish(0);
          end
        end
      endmodule
    expect:
      variables:
        counter: 5
