feature: functions
description: Tests for user-defined functions (basic usage)

cases:
  - name: function_simple_return
    sv: |
      module Test;
        int result;

        function int get_value();
          return 42;
        endfunction

        initial begin
          result = get_value();
        end
      endmodule
    expect:
      variables:
        result: 42

  - name: function_with_parameter
    sv: |
      module Test;
        int result;

        function int double_it(int x);
          return x * 2;
        endfunction

        initial begin
          result = double_it(21);
        end
      endmodule
    expect:
      variables:
        result: 42

  - name: function_multiple_parameters
    sv: |
      module Test;
        int result;

        function int add(int a, int b);
          return a + b;
        endfunction

        initial begin
          result = add(17, 25);
        end
      endmodule
    expect:
      variables:
        result: 42

  - name: function_local_variable
    sv: |
      module Test;
        int result;

        function int compute(int x);
          int temp;
          temp = x + 10;
          return temp * 2;
        endfunction

        initial begin
          result = compute(11);
        end
      endmodule
    expect:
      variables:
        result: 42

  - name: function_void
    sv: |
      module Test;
        int counter;

        function void increment();
          counter = counter + 1;
        endfunction

        initial begin
          counter = 0;
          increment();
          increment();
          increment();
        end
      endmodule
    expect:
      variables:
        counter: 3

  - name: function_in_expression
    sv: |
      module Test;
        int result;

        function int square(int x);
          return x * x;
        endfunction

        initial begin
          result = square(3) + square(4);
        end
      endmodule
    expect:
      variables:
        result: 25

  - name: function_conditional_return
    sv: |
      module Test;
        int result;

        function int max(int a, int b);
          if (a > b)
            return a;
          else
            return b;
        endfunction

        initial begin
          result = max(15, 27);
        end
      endmodule
    expect:
      variables:
        result: 27

  - name: function_early_return
    sv: |
      module Test;
        int result;

        function int check(int x);
          if (x < 0)
            return -1;
          if (x == 0)
            return 0;
          return 1;
        endfunction

        initial begin
          result = check(5) + check(0) * 10 + check(-3) * 100;
        end
      endmodule
    expect:
      variables:
        result: -99

  - name: function_modifies_module_variable
    sv: |
      module Test;
        int global_counter;
        int result;

        function int increment_and_return();
          global_counter = global_counter + 1;
          return global_counter;
        endfunction

        initial begin
          global_counter = 10;
          result = increment_and_return();
        end
      endmodule
    expect:
      variables:
        global_counter: 11
        result: 11

  - name: function_return_by_name
    sv: |
      module Test;
        int result;

        function int foo();
          foo = 42;
        endfunction

        initial begin
          result = foo();
        end
      endmodule
    expect:
      variables:
        result: 42

  - name: function_return_by_name_mixed
    sv: |
      module Test;
        int result;

        function int bar(int x);
          if (x > 0)
            return x;
          else
            bar = -x;
        endfunction

        initial begin
          result = bar(5) + bar(-3);
        end
      endmodule
    expect:
      variables:
        result: 8

  - name: function_return_by_name_readback
    sv: |
      module Test;
        int result;

        function int baz();
          baz = 3;
          baz = baz + 1;
        endfunction

        initial begin
          result = baz();
        end
      endmodule
    expect:
      variables:
        result: 4

  - name: function_return_by_name_recursive
    sv: |
      module Test;
        int result;

        function automatic int factorial(int n);
          if (n <= 1)
            factorial = 1;
          else
            factorial = n * factorial(n - 1);
        endfunction

        initial begin
          result = factorial(5);
        end
      endmodule
    expect:
      variables:
        result: 120

  - name: function_implicit_default_return
    sv: |
      module Test;
        int result;

        // Function with no assignment and no return - should return default (0)
        function int no_assignment();
          // empty body
        endfunction

        initial begin
          result = no_assignment();
        end
      endmodule
    expect:
      variables:
        result: 0

  - name: function_uninitialized_local_default
    sv: |
      module Test;
        int result;

        // Uninitialized local should have default value (0 for int)
        function int uninit_local();
          int local_var;
          return local_var;
        endfunction

        initial begin
          result = uninit_local();
        end
      endmodule
    expect:
      variables:
        result: 0

  - name: function_uninitialized_4state_local_default
    description: Uninitialized 4-state local should be X (not 0)
    sv: |
      module Test;
        int result;

        // Uninitialized 4-state local (logic) should be X
        // Use case equality to test: if x === 4'bxxxx, return 1
        function automatic int f();
          logic [3:0] x;
          if (x === 4'bxxxx)
            f = 1;
          else
            f = 0;
        endfunction

        initial begin
          result = f();
        end
      endmodule
    expect:
      variables:
        result: 1
