feature: datatypes_dynamic_arrays
description: Dynamic arrays with runtime-sized allocation (IEEE 1800-2023 Section 7.5)

cases:
  - name: declaration_empty
    description: Empty dynamic array declaration has size 0
    sv: |
      module Test;
        int size;
        initial begin
          int arr[];
          size = arr.size();
        end
      endmodule
    expect:
      variables:
        size: 0

  - name: basic_allocation
    description: Allocate array with new[N]
    sv: |
      module Test;
        int size;
        initial begin
          int arr[];
          arr = new[5];
          size = arr.size();
        end
      endmodule
    expect:
      variables:
        size: 5

  - name: element_write_read
    description: Write and read array elements by index
    sv: |
      module Test;
        int a;
        int b;
        int c;
        initial begin
          int arr[];
          arr = new[3];
          arr[0] = 10;
          arr[1] = 20;
          arr[2] = 30;
          a = arr[0];
          b = arr[1];
          c = arr[2];
        end
      endmodule
    expect:
      variables:
        a: 10
        b: 20
        c: 30

  - name: variable_index
    description: Access elements with variable index
    sv: |
      module Test;
        int result;
        initial begin
          int arr[];
          int idx;
          arr = new[4];
          arr[0] = 100;
          arr[1] = 200;
          arr[2] = 300;
          arr[3] = 400;
          idx = 2;
          result = arr[idx];
        end
      endmodule
    expect:
      variables:
        result: 300

  - name: size_method
    description: size() returns current array size
    sv: |
      module Test;
        int s1;
        int s2;
        initial begin
          int arr[];
          arr = new[3];
          s1 = arr.size();
          arr = new[7];
          s2 = arr.size();
        end
      endmodule
    expect:
      variables:
        s1: 3
        s2: 7

  - name: delete_method
    description: delete() clears the array
    sv: |
      module Test;
        int sz_before;
        int sz_after;
        initial begin
          int arr[];
          arr = new[5];
          sz_before = arr.size();
          arr.delete();
          sz_after = arr.size();
        end
      endmodule
    expect:
      variables:
        sz_before: 5
        sz_after: 0

  - name: realloc_after_delete
    description: Array can be reallocated after delete
    sv: |
      module Test;
        int s1;
        int s2;
        int s3;
        int val;
        initial begin
          int arr[];
          arr = new[3];
          arr[0] = 42;
          s1 = arr.size();
          arr.delete();
          s2 = arr.size();
          arr = new[2];
          arr[0] = 99;
          s3 = arr.size();
          val = arr[0];
        end
      endmodule
    expect:
      variables:
        s1: 3
        s2: 0
        s3: 2
        val: 99

  - name: loop_with_size
    description: Use size() in loop condition
    sv: |
      module Test;
        int sum;
        initial begin
          int arr[];
          arr = new[4];
          arr[0] = 1;
          arr[1] = 2;
          arr[2] = 3;
          arr[3] = 4;
          sum = 0;
          for (int i = 0; i < arr.size(); i++) begin
            sum = sum + arr[i];
          end
        end
      endmodule
    expect:
      variables:
        sum: 10

  - name: sum_elements
    description: Sum all elements using index loop
    sv: |
      module Test;
        int sum;
        initial begin
          int arr[];
          int n;
          arr = new[5];
          arr[0] = 10;
          arr[1] = 20;
          arr[2] = 30;
          arr[3] = 40;
          arr[4] = 50;
          sum = 0;
          n = arr.size();
          for (int i = 0; i < n; i++) begin
            sum = sum + arr[i];
          end
        end
      endmodule
    expect:
      variables:
        sum: 150

  - name: display_output
    description: Display dynamic array values
    sv: |
      module Test;
        initial begin
          int arr[];
          arr = new[3];
          arr[0] = 100;
          arr[1] = 200;
          arr[2] = 300;
          $display("size=%0d, arr[1]=%0d", arr.size(), arr[1]);
        end
      endmodule
    expect:
      output: "size=3, arr[1]=200\n"

  - name: module_level_decl
    description: Dynamic array declared at module level
    sv: |
      module Test;
        int arr[];
        int size;
        initial begin
          arr = new[4];
          arr[0] = 5;
          size = arr.size();
        end
      endmodule
    expect:
      variables:
        size: 4

  - name: default_values
    description: Newly allocated elements have default value 0
    sv: |
      module Test;
        int a;
        int b;
        int c;
        initial begin
          int arr[];
          arr = new[3];
          a = arr[0];
          b = arr[1];
          c = arr[2];
        end
      endmodule
    expect:
      variables:
        a: 0
        b: 0
        c: 0

  - name: new_with_copy
    description: Allocate with copy from existing array
    sv: |
      module Test;
        int a;
        int b;
        int c;
        initial begin
          int src[];
          int dst[];
          src = new[3];
          src[0] = 100;
          src[1] = 200;
          src[2] = 300;
          dst = new[5](src);
          a = dst[0];
          b = dst[2];
          c = dst[4];
        end
      endmodule
    expect:
      variables:
        a: 100
        b: 300
        c: 0

  - name: multidim_basic
    description: Basic 2D dynamic array allocation and access
    sv: |
      module Test;
        int arr[][];
        int v00;
        int v01;
        int v10;
        int outer_size;
        int inner0_size;
        int inner1_size;
        initial begin
          arr = new[2];
          arr[0] = new[3];
          arr[1] = new[2];
          arr[0][0] = 10;
          arr[0][1] = 20;
          arr[0][2] = 30;
          arr[1][0] = 100;
          arr[1][1] = 200;
          v00 = arr[0][0];
          v01 = arr[0][1];
          v10 = arr[1][0];
          outer_size = arr.size();
          inner0_size = arr[0].size();
          inner1_size = arr[1].size();
        end
      endmodule
    expect:
      variables:
        v00: 10
        v01: 20
        v10: 100
        outer_size: 2
        inner0_size: 3
        inner1_size: 2

  - name: multidim_assignment_independence
    description: Assignment creates independent copy (not shared reference)
    sv: |
      module Test;
        int arr[][];
        int copy[][];
        int arr_val;
        int copy_val;
        initial begin
          arr = new[1];
          arr[0] = new[1];
          arr[0][0] = 1;
          copy = arr;
          copy[0][0] = 999;
          arr_val = arr[0][0];
          copy_val = copy[0][0];
        end
      endmodule
    expect:
      variables:
        arr_val: 1
        copy_val: 999

  - name: multidim_new_copy_independence
    description: new[](init) creates independent copy
    sv: |
      module Test;
        int arr[][];
        int copy[][];
        int arr_val;
        int copy_val;
        int copy_size;
        int copy2_size;
        initial begin
          arr = new[1];
          arr[0] = new[1];
          arr[0][0] = 1;
          copy = new[2](arr);
          copy[0][0] = 999;
          arr_val = arr[0][0];
          copy_val = copy[0][0];
          copy_size = copy.size();
          copy2_size = copy[1].size();
        end
      endmodule
    expect:
      variables:
        arr_val: 1
        copy_val: 999
        copy_size: 2
        copy2_size: 0

  - name: mixed_fixed_dynamic
    description: Fixed-size array of dynamic arrays
    sv: |
      module Test;
        int mixed[2][];
        int v00;
        int v10;
        int s0;
        int s1;
        initial begin
          mixed[0] = new[3];
          mixed[1] = new[5];
          mixed[0][0] = 42;
          mixed[1][0] = 99;
          v00 = mixed[0][0];
          v10 = mixed[1][0];
          s0 = mixed[0].size();
          s1 = mixed[1].size();
        end
      endmodule
    expect:
      variables:
        v00: 42
        v10: 99
        s0: 3
        s1: 5
