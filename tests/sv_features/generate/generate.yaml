feature: generate_generate
description: Tests generate constructs (if-generate, for-generate, and case-generate)

cases:
  - name: if_generate_continuous_assign
    description: if-generate selecting continuous assignment based on parameter
    sv: |
      module Test;
        parameter int MODE = 1;
        int a, b, c;
        if (MODE == 1) begin : gen_add
          assign c = a + b;
        end else begin : gen_sub
          assign c = a - b;
        end
        initial begin
          a = 5; b = 3;
          #1;
          $display("c=%0d", c);
        end
      endmodule
    expect:
      stdout: "c=8\n"

  - name: if_generate_always_comb
    description: if-generate selecting always_comb block
    sv: |
      module Test;
        parameter int MODE = 0;
        int x, y;
        if (MODE == 0) begin : gen_double
          always_comb y = x * 2;
        end else begin : gen_triple
          always_comb y = x * 3;
        end
        initial begin
          x = 10;
          #1;
          $display("y=%0d", y);
        end
      endmodule
    expect:
      stdout: "y=20\n"

  - name: if_generate_initial
    description: Initial block inside generate
    sv: |
      module Test;
        parameter int ENABLE = 1;
        int value = 0;
        if (ENABLE) begin : gen_init
          initial begin
            value = 42;
          end
        end
        initial begin
          #1;
          $display("value=%0d", value);
        end
      endmodule
    expect:
      stdout: "value=42\n"

  - name: if_generate_false_branch
    description: Condition is false, else branch taken
    sv: |
      module Test;
        parameter int USE_ADD = 0;
        int a, b, result;
        if (USE_ADD) begin : gen_add
          assign result = a + b;
        end else begin : gen_mul
          assign result = a * b;
        end
        initial begin
          a = 3; b = 4;
          #1;
          $display("result=%0d", result);
        end
      endmodule
    expect:
      stdout: "result=12\n"

  - name: if_generate_no_else
    description: if-generate without else branch (condition false = nothing)
    sv: |
      module Test;
        parameter int ENABLE = 0;
        int x = 5;
        if (ENABLE) begin : gen_block
          initial x = 100;
        end
        initial begin
          #1;
          $display("x=%0d", x);
        end
      endmodule
    expect:
      stdout: "x=5\n"

  - name: nested_if_generate
    description: Nested if-generate constructs
    sv: |
      module Test;
        parameter int A = 1;
        parameter int B = 1;
        int x, result;
        if (A) begin : gen_a
          if (B) begin : gen_b
            assign result = x + 11;
          end else begin : gen_not_b
            assign result = x + 10;
          end
        end else begin : gen_not_a
          assign result = x;
        end
        initial begin
          x = 0;
          #1;
          $display("result=%0d", result);
        end
      endmodule
    expect:
      stdout: "result=11\n"

  - name: if_generate_variable
    description: Variable declared inside generate block
    sv: |
      module Test;
        parameter int USE_INTERNAL = 1;
        int result = 0;
        if (USE_INTERNAL) begin : gen_internal
          int internal_var;
          initial begin
            internal_var = 77;
            result = internal_var;
          end
        end
        initial begin
          #1;
          $display("result=%0d", result);
        end
      endmodule
    expect:
      stdout: "result=77\n"

  - name: if_generate_function
    description: Function defined inside generate block
    sv: |
      module Test;
        parameter int MODE = 1;
        int x;
        if (MODE == 1) begin : gen_func
          function int multiply_by_two(int val);
            return val * 2;
          endfunction
          initial x = multiply_by_two(21);
        end
        initial begin
          #1;
          $display("x=%0d", x);
        end
      endmodule
    expect:
      stdout: "x=42\n"

  - name: if_generate_submodule
    description: Module instance inside generate block
    sv: |
      module Adder(input int a, input int b, output int sum);
        always_comb sum = a + b;
      endmodule

      module Multiplier(input int a, input int b, output int prod);
        always_comb prod = a * b;
      endmodule

      module Test;
        parameter int USE_ADDER = 1;
        int x, y, result;
        if (USE_ADDER) begin : gen_adder
          Adder op(.a(x), .b(y), .sum(result));
        end else begin : gen_mult
          Multiplier op(.a(x), .b(y), .prod(result));
        end
        initial begin
          x = 3; y = 7;
          #1;
          $display("result=%0d", result);
        end
      endmodule
    expect:
      stdout: "result=10\n"

  - name: for_generate_basic
    description: Basic for-generate loop with genvar
    sv: |
      module Test;
        genvar i;
        for (i = 0; i < 4; i = i + 1) begin : blk
          initial $display("i=%0d", i);
        end
      endmodule
    expect:
      stdout: |
        i=0
        i=1
        i=2
        i=3

  - name: for_generate_always_comb
    description: always_comb inside for-generate loop
    sv: |
      module Test;
        int x, y0, y1, y2;
        genvar i;
        for (i = 0; i < 3; i = i + 1) begin : blk
          if (i == 0) always_comb y0 = x + i;
          if (i == 1) always_comb y1 = x + i;
          if (i == 2) always_comb y2 = x + i;
        end
        initial begin
          x = 10;
          #1;
          $display("y0=%0d y1=%0d y2=%0d", y0, y1, y2);
        end
      endmodule
    expect:
      stdout: "y0=10 y1=11 y2=12\n"

  - name: nested_for_generate
    description: Nested for-generate loops
    sv: |
      module Test;
        genvar i, j;
        for (i = 0; i < 2; i = i + 1) begin : outer
          for (j = 0; j < 2; j = j + 1) begin : inner
            initial $display("i=%0d j=%0d", i, j);
          end
        end
      endmodule
    expect:
      stdout: |
        i=0 j=0
        i=0 j=1
        i=1 j=0
        i=1 j=1

  - name: for_generate_with_if
    description: if-generate inside for-generate loop
    sv: |
      module Test;
        genvar i;
        for (i = 0; i < 4; i = i + 1) begin : blk
          if (i % 2 == 0) begin : even
            initial $display("even: %0d", i);
          end
        end
      endmodule
    expect:
      stdout: |
        even: 0
        even: 2

  - name: for_generate_zero_iterations
    description: for-generate with zero iterations
    sv: |
      module Test;
        genvar i;
        for (i = 0; i < 0; i = i + 1) begin : blk
          initial $display("never");
        end
        initial $display("done");
      endmodule
    expect:
      stdout:
        contains:
          - "done"
        not_contains:
          - "never"

  - name: for_generate_submodule
    description: Module instance inside for-generate loop
    sv: |
      module Doubler(input int x, output int y);
        always_comb y = x * 2;
      endmodule

      module Test;
        int in0, in1, out0, out1;
        genvar i;
        for (i = 0; i < 2; i = i + 1) begin : dbl
          if (i == 0) Doubler d0(.x(in0), .y(out0));
          if (i == 1) Doubler d1(.x(in1), .y(out1));
        end
        initial begin
          in0 = 3;
          in1 = 5;
          #1;
          $display("out0=%0d out1=%0d", out0, out1);
        end
      endmodule
    expect:
      stdout: "out0=6 out1=10\n"

  - name: case_generate_basic
    description: case-generate selecting initial block based on parameter
    sv: |
      module Test;
        parameter int WIDTH = 2;
        int result;
        case (WIDTH)
          1: begin : gen
            initial result = 100;
          end
          2: begin : gen
            initial result = 200;
          end
          default: begin : gen
            initial result = 999;
          end
        endcase
        initial begin
          #1;
          $display("result=%0d", result);
        end
      endmodule
    expect:
      stdout: "result=200\n"

  - name: case_generate_default
    description: case-generate falling through to default case
    sv: |
      module Test;
        parameter int WIDTH = 5;
        int result;
        case (WIDTH)
          1: begin : gen
            initial result = 100;
          end
          2: begin : gen
            initial result = 200;
          end
          default: begin : gen
            initial result = 999;
          end
        endcase
        initial begin
          #1;
          $display("result=%0d", result);
        end
      endmodule
    expect:
      stdout: "result=999\n"

  - name: case_generate_continuous_assign
    description: case-generate selecting continuous assignment
    sv: |
      module Test;
        parameter int MODE = 1;
        int x, y;
        case (MODE)
          0: begin : gen
            assign y = x;
          end
          1: begin : gen
            assign y = x * 2;
          end
          2: begin : gen
            assign y = x * 3;
          end
        endcase
        initial begin
          x = 10;
          #1;
          $display("y=%0d", y);
        end
      endmodule
    expect:
      stdout: "y=20\n"

  - name: case_generate_always_comb
    description: case-generate selecting always_comb block
    sv: |
      module Test;
        parameter int OP = 2;
        int a, b, result;
        case (OP)
          0: begin : gen
            always_comb result = a + b;
          end
          1: begin : gen
            always_comb result = a - b;
          end
          2: begin : gen
            always_comb result = a * b;
          end
        endcase
        initial begin
          a = 3; b = 4;
          #1;
          $display("result=%0d", result);
        end
      endmodule
    expect:
      stdout: "result=12\n"

  - name: case_generate_function
    description: Function defined inside case-generate block
    sv: |
      module Test;
        parameter int MODE = 1;
        int x;
        case (MODE)
          0: begin : gen
            function int compute(int val);
              return val + 1;
            endfunction
            initial x = compute(10);
          end
          1: begin : gen
            function int compute(int val);
              return val * 2;
            endfunction
            initial x = compute(10);
          end
        endcase
        initial begin
          #1;
          $display("x=%0d", x);
        end
      endmodule
    expect:
      stdout: "x=20\n"

  - name: case_generate_submodule
    description: Module instance inside case-generate block
    sv: |
      module Adder(input int a, input int b, output int c);
        always_comb c = a + b;
      endmodule

      module Multiplier(input int a, input int b, output int c);
        always_comb c = a * b;
      endmodule

      module Test;
        parameter int USE_MUL = 1;
        int x, y, result;
        case (USE_MUL)
          0: begin : gen
            Adder op(.a(x), .b(y), .c(result));
          end
          1: begin : gen
            Multiplier op(.a(x), .b(y), .c(result));
          end
        endcase
        initial begin
          x = 3; y = 7;
          #1;
          $display("result=%0d", result);
        end
      endmodule
    expect:
      stdout: "result=21\n"

  - name: for_generate_hierarchical_ref
    description: Hierarchical reference to variable inside for-generate block
    sv: |
      module Test;
        genvar i;
        for (i = 0; i < 2; i = i + 1) begin : gen_block
          int counter;
        end
        initial begin
          gen_block[0].counter = 10;
          gen_block[1].counter = 20;
          $display("gen_block[0].counter = %0d", gen_block[0].counter);
          $display("gen_block[1].counter = %0d", gen_block[1].counter);
        end
      endmodule
    expect:
      stdout: "gen_block[0].counter = 10\ngen_block[1].counter = 20\n"

  - name: for_generate_hierarchical_ref_multiple_vars
    description: Hierarchical reference to multiple variables inside for-generate
    sv: |
      module Test;
        genvar i;
        for (i = 0; i < 3; i = i + 1) begin : blk
          int x;
          int y;
        end
        initial begin
          blk[0].x = 1; blk[0].y = 2;
          blk[1].x = 10; blk[1].y = 20;
          blk[2].x = 100; blk[2].y = 200;
          $display("%0d %0d %0d %0d %0d %0d",
            blk[0].x, blk[0].y, blk[1].x, blk[1].y, blk[2].x, blk[2].y);
        end
      endmodule
    expect:
      stdout: "1 2 10 20 100 200\n"

  - name: if_generate_hierarchical_ref
    description: Hierarchical reference to variable inside if-generate block
    sv: |
      module Test;
        parameter bit ENABLE = 1;
        if (ENABLE) begin : enabled
          int value;
        end
        initial begin
          enabled.value = 42;
          $display("enabled.value = %0d", enabled.value);
        end
      endmodule
    expect:
      stdout: "enabled.value = 42\n"

  - name: nested_for_generate_variables
    description: Variables in nested for-generate blocks with hierarchical access
    sv: |
      module Test;
        genvar i, j;
        for (i = 0; i < 2; i = i + 1) begin : outer
          int x;
          for (j = 0; j < 2; j = j + 1) begin : inner
            int y;
          end
        end
        initial begin
          outer[0].x = 10;
          outer[1].x = 20;
          outer[0].inner[0].y = 100;
          outer[0].inner[1].y = 101;
          outer[1].inner[0].y = 200;
          outer[1].inner[1].y = 201;
          $display("outer[0].x=%0d outer[1].x=%0d", outer[0].x, outer[1].x);
          $display("outer[0].inner[0].y=%0d outer[0].inner[1].y=%0d",
            outer[0].inner[0].y, outer[0].inner[1].y);
          $display("outer[1].inner[0].y=%0d outer[1].inner[1].y=%0d",
            outer[1].inner[0].y, outer[1].inner[1].y);
        end
      endmodule
    expect:
      stdout: "outer[0].x=10 outer[1].x=20\nouter[0].inner[0].y=100 outer[0].inner[1].y=101\nouter[1].inner[0].y=200 outer[1].inner[1].y=201\n"

  - name: nested_if_in_for_generate_variables
    description: Variables in if-generate nested inside for-generate
    sv: |
      module Test;
        genvar i;
        for (i = 0; i < 2; i = i + 1) begin : outer
          int x;
          if (i == 0) begin : inner
            int y;
          end
        end
        initial begin
          outer[0].x = 10;
          outer[1].x = 20;
          outer[0].inner.y = 42;
          $display("outer[0].x=%0d outer[1].x=%0d", outer[0].x, outer[1].x);
          $display("outer[0].inner.y=%0d", outer[0].inner.y);
        end
      endmodule
    expect:
      stdout: "outer[0].x=10 outer[1].x=20\nouter[0].inner.y=42\n"

  - name: nested_for_in_if_generate_variables
    description: Variables in for-generate nested inside if-generate
    sv: |
      module Test;
        parameter bit ENABLE = 1;
        genvar i;
        if (ENABLE) begin : outer
          int x;
          for (i = 0; i < 2; i = i + 1) begin : inner
            int y;
          end
        end
        initial begin
          outer.x = 10;
          outer.inner[0].y = 100;
          outer.inner[1].y = 200;
          $display("outer.x=%0d", outer.x);
          $display("outer.inner[0].y=%0d outer.inner[1].y=%0d",
            outer.inner[0].y, outer.inner[1].y);
        end
      endmodule
    expect:
      stdout: "outer.x=10\nouter.inner[0].y=100 outer.inner[1].y=200\n"
