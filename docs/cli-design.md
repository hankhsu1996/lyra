# Lyra CLI Design

Design document for the `lyra` command-line tool.

## Vision

A Cargo-like CLI that makes SystemVerilog simulation simple. Configuration lives in a project file, not in complex flags.

## Backends

Two execution backends:

| Backend     | Path                          | Use Case                    |
| ----------- | ----------------------------- | --------------------------- |
| Interpreter | AST → MIR → LIR → Interpreter | Development, debugging      |
| Codegen     | AST → MIR → C++ → Binary      | Performance, production use |

Codegen will be the primary backend for real use (faster execution). Interpreter is useful for development iteration (no compile step).

## Subcommands

```
lyra run      # Simulate (codegen by default)
lyra build    # Generate binary only (no run)
lyra emit     # Emit self-contained C++ project
lyra check    # Parse and validate, report errors
```

### Backend Selection

Codegen is the default - it's the production path we ship.

```bash
lyra run                  # Codegen (default)
lyra run --interpret      # Interpreter (for development/debugging)
```

Interpreter is useful during development (no compile wait), but codegen is the real product.

### Output Folder

All commands share the `out/` folder:

```
out/
├── CMakeLists.txt       # Build configuration
├── src/
│   └── my_design.cpp    # Generated simulation code
├── include/
│   └── lyra/
│       └── sdk/         # SDK headers (copied)
└── sim                  # Compiled binary (after build)
```

- `lyra emit` - generates C++ project to `out/`
- `lyra build` - emit + compile binary
- `lyra run` - build + execute

User has full control - can modify generated code, integrate into larger project, or use their own build system.

## Project Configuration

File: `lyra.toml`

```toml
[package]
name = "my_design"
top = "Top"

[sources]
files = ["src/top.sv", "src/sub.sv"]
filelists = ["rtl.f", "tb.f"]    # Optional: .f files with source lists
incdir = ["src/", "include/"]    # Include directories for `include
```

All fields in `[sources]` are optional. Use whichever fits your project.

## CLI Examples

```bash
# Initialize new project
lyra init my_project

# Run simulation (codegen, default)
lyra run

# Run with interpreter (faster iteration, no compile)
lyra run --interpret

# Build binary only (don't run)
lyra build

# Emit C++ project to out/
lyra emit

# Check syntax only (fast validation)
lyra check
```

## Directory Structure

```
my_project/
├── lyra.toml
├── src/
│   ├── top.sv
│   └── modules/
│       └── sub.sv
└── out/             # Generated by lyra
    ├── CMakeLists.txt
    ├── src/
    ├── include/
    └── sim
```

## Internal Architecture

### Directory Structure (library)

```
include/lyra/
├── interpreter/                   # Interpreter backend
│   ├── interpreter.hpp            # Entry point
│   ├── interpreter_result.hpp     # Result type
│   └── interpreter_options.hpp    # Debug/trace options
│
├── compiler/                      # Compiler backend
│   ├── compiler.hpp               # Entry point (codegen + compile + run)
│   ├── compiler_result.hpp        # Result type
│   └── codegen.hpp                # Internal: generates C++ from MIR
│
└── cli/                           # CLI entry point
    ├── driver.hpp                 # CLI orchestration
    └── config.hpp                 # lyra.toml parsing
```

### Classes

| Class                | Location       | Role                                         |
| -------------------- | -------------- | -------------------------------------------- |
| `Interpreter`        | `interpreter/` | Entry point: MIR → LIR → run                 |
| `InterpreterResult`  | `interpreter/` | Result: context, variable access, final time |
| `InterpreterOptions` | `interpreter/` | Debug flags (dump_lir, trace)                |
| `Compiler`           | `compiler/`    | Entry point: MIR → C++ → compile → run       |
| `CompilerResult`     | `compiler/`    | Result: variable values, final time          |
| `Codegen`            | `compiler/`    | Internal: generates C++ source from MIR      |
| `Driver`             | `cli/`         | CLI main logic, dispatches to backends       |
| `Config`             | `cli/`         | Parses lyra.toml                             |

## Design Decisions

- **Config format**: TOML (using tomlplusplus)
- **Default backend**: Codegen (production path)
- **Subcommands**: `run`, `build`, `emit`, `check`
- **Multi-top**: No, keep it simple (one top module per project)
- **Dependencies**: No, SV projects usually don't have deps
