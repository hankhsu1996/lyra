feature: file_output
description: Tests for $fdisplay and $fwrite system tasks

cases:
  - name: fdisplay_mcd_stdout
    description: $fdisplay with MCD bit 0 writes to stdout/transcript
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fdisplay(1, "hello from fdisplay");
            end
          endmodule
    expect:
      stdout: |
        hello from fdisplay

  - name: fwrite_mcd_stdout
    description: $fwrite with MCD bit 0 writes to stdout without newline
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fwrite(1, "no");
              $fwrite(1, "newline");
              $display("");
            end
          endmodule
    expect:
      stdout: |
        nonewline

  - name: fdisplay_format_string
    description: $fdisplay with format string
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fdisplay(1, "value=%d", 42);
            end
          endmodule
    expect:
      stdout: |
        value=42

  - name: fdisplay_multiple_args
    description: $fdisplay with multiple format arguments
    files:
      - name: test.sv
        content: |
          module Test;
            int a = 10, b = 20;
            initial begin
              $fdisplay(1, "a=%d b=%d sum=%d", a, b, a+b);
            end
          endmodule
    expect:
      stdout: |
        a=10 b=20 sum=30

  - name: fdisplayh_hex_format
    description: $fdisplayh uses hex format by default
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fdisplayh(1, 255);
            end
          endmodule
    expect:
      stdout: |
        ff

  - name: fdisplayb_binary_format
    description: $fdisplayb uses binary format by default
    files:
      - name: test.sv
        content: |
          module Test;
            logic [3:0] x = 4'b1010;
            initial begin
              $fdisplayb(1, x);
            end
          endmodule
    expect:
      stdout: |
        1010

  - name: fdisplayo_octal_format
    description: $fdisplayo uses octal format by default
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fdisplayo(1, 63);
            end
          endmodule
    expect:
      stdout: |
        77

  - name: fdisplay_file_then_close
    description: $fdisplay to file followed by close
    files:
      - name: test.sv
        content: |
          module Test;
            int fd;
            int opened;
            initial begin
              fd = $fopen("output.txt", "w");
              opened = (fd != 0) ? 1 : 0;
              $fdisplay(fd, "written to file");
              $fclose(fd);
            end
          endmodule
    expect:
      variables:
        opened: 1

  - name: fdisplay_empty
    description: $fdisplay with only descriptor prints newline
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fwrite(1, "before");
              $fdisplay(1);
              $fwrite(1, "after");
              $display("");
            end
          endmodule
    expect:
      stdout: |
        before
        after

  - name: fwrite_empty
    description: $fwrite with only descriptor does nothing
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fwrite(1, "only");
              $fwrite(1);
              $fwrite(1, "this");
              $display("");
            end
          endmodule
    expect:
      stdout: |
        onlythis

  - name: fdisplay_invalid_descriptor
    description: $fdisplay with invalid descriptor (0) is silently ignored
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fdisplay(0, "should not appear");
              $display("OK");
            end
          endmodule
    expect:
      stdout: |
        OK

  - name: fdisplay_mcd_or
    description: $fdisplay with OR-ed MCD writes to multiple channels
    files:
      - name: test.sv
        content: |
          module Test;
            int fd1, fd2;
            initial begin
              fd1 = $fopen("out1.txt");
              fd2 = $fopen("out2.txt");
              // OR with bit 0 also writes to stdout
              $fdisplay(1 | fd1 | fd2, "to all three");
              $fclose(fd1);
              $fclose(fd2);
            end
          endmodule
    expect:
      stdout: |
        to all three

  - name: fwriteh_hex_format
    description: $fwriteh uses hex format without newline
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fwriteh(1, 255);
              $display("");
            end
          endmodule
    expect:
      stdout: |
        ff

  - name: fwrite_descriptor_expression
    description: $fwrite with descriptor as variable expression
    files:
      - name: test.sv
        content: |
          module Test;
            int desc;
            initial begin
              desc = 1;
              $fwrite(desc, "via variable");
              $display("");
            end
          endmodule
    expect:
      stdout: |
        via variable

  - name: fdisplay_packed_literal_format
    description: $fdisplay with packed string literal (regression test)
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fdisplay(1, "val=%d end", 99);
            end
          endmodule
    expect:
      stdout: |
        val=99 end

  - name: fstrobe_basic
    description: $fstrobe writes to file in Postponed region
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fstrobe(1, "strobe output");
              $display("display first");
            end
          endmodule
    expect:
      stdout: |
        display first
        strobe output

  - name: fstrobe_format_string
    description: $fstrobe with format arguments
    files:
      - name: test.sv
        content: |
          module Test;
            int x = 42;
            initial begin
              $fstrobe(1, "x=%d", x);
            end
          endmodule
    expect:
      stdout: |
        x=42

  - name: fstrobeh_hex
    description: $fstrobeh uses hex format
    files:
      - name: test.sv
        content: |
          module Test;
            initial begin
              $fstrobeh(1, 255);
            end
          endmodule
    expect:
      stdout: |
        ff

  - name: fmonitor_initial_print
    description: $fmonitor prints immediately on registration
    files:
      - name: test.sv
        content: |
          module Test;
            int x = 10;
            initial begin
              $fmonitor(1, "x=%d", x);
            end
          endmodule
    expect:
      stdout: |
        x=10

  - name: fmonitor_change_detection
    description: $fmonitor prints on value change to file
    files:
      - name: test.sv
        content: |
          module Test;
            int x = 1;
            initial begin
              $fmonitor(1, "x=%d", x);
              #1 x = 2;
              #1 x = 3;
            end
          endmodule
    expect:
      stdout: |
        x=1
        x=2
        x=3

  - name: fmonitorh_hex
    description: $fmonitorh uses hex format
    files:
      - name: test.sv
        content: |
          module Test;
            int x = 255;
            initial begin
              $fmonitorh(1, x);
            end
          endmodule
    expect:
      stdout: |
        ff

  - name: fclose_cancels_fmonitor
    description: $fclose cancels active $fmonitor to that file
    files:
      - name: test.sv
        content: |
          module Test;
            int x = 1;
            int fd;
            initial begin
              fd = $fopen("output.txt", "w");
              $fmonitor(fd, "x=%d", x);
              #1 x = 2;
              $fclose(fd);
              #1 x = 3;
              $display("done");
            end
          endmodule
    expect:
      stdout: |
        done

  - name: fmonitor_replace
    description: New $fmonitor replaces active one (old monitor does not print)
    files:
      - name: test.sv
        content: |
          module Test;
            int x = 1, y = 10;
            initial begin
              $fmonitor(1, "x=%d", x);
              #1 x = 2;
              $fmonitor(1, "y=%d", y);
              #1 y = 20;
              #1 x = 3;
            end
          endmodule
    expect:
      stdout: |
        x=1
        y=10
        y=20

  - name: fstrobe_after_fclose
    description: $fstrobe to closed file is silently ignored
    files:
      - name: test.sv
        content: |
          module Test;
            int fd;
            initial begin
              fd = $fopen("output.txt", "w");
              $fstrobe(fd, "should not appear");
              $fclose(fd);
              $display("done");
            end
          endmodule
    expect:
      stdout: |
        done

  - name: fdisplay_to_file_verified
    description: $fdisplay writes to actual file (content verified)
    files:
      - name: test.sv
        content: |
          module Test;
            int fd;
            initial begin
              fd = $fopen("output.txt", "w");
              $fdisplay(fd, "hello world");
              $fclose(fd);
            end
          endmodule
    expect:
      files:
        output.txt: "hello world\n"

  - name: mcd_or_both_files_verified
    description: MCD OR writes to both files (both verified)
    files:
      - name: test.sv
        content: |
          module Test;
            int mcd1, mcd2;
            initial begin
              mcd1 = $fopen("file1.txt");
              mcd2 = $fopen("file2.txt");
              $fdisplay(mcd1 | mcd2, "to both");
              $fclose(mcd1);
              $fclose(mcd2);
            end
          endmodule
    expect:
      files:
        file1.txt: "to both\n"
        file2.txt: "to both\n"

  - name: fstrobe_after_fclose_file_empty
    description: $fstrobe to closed file produces empty file
    files:
      - name: test.sv
        content: |
          module Test;
            int fd;
            initial begin
              fd = $fopen("output.txt", "w");
              $fstrobe(fd, "should not appear");
              $fclose(fd);
            end
          endmodule
    expect:
      files:
        output.txt: ""

  - name: fmonitor_cancel_verified
    description: $fclose cancels $fmonitor (no writes after close)
    files:
      - name: test.sv
        content: |
          module Test;
            int x = 1;
            int fd;
            initial begin
              fd = $fopen("output.txt", "w");
              $fmonitor(fd, "x=%d", x);
              #1 x = 2;
              // IMPORTANT: This #1 is required for correct region ordering.
              // $fmonitor writes in Postponed region at end of time step.
              // Without this delay, $fclose executes in Active region of
              // time 1 (same step as x=2), cancelling the monitor BEFORE
              // Postponed runs. The delay ensures x=2 writes before close.
              #1;
              $fclose(fd);
              #1 x = 3;  // After close - should not write
            end
          endmodule
    expect:
      files:
        output.txt:
          contains:
            - "x=1"
            - "x=2"
          not_contains:
            - "x=3"

  - name: fwrite_multiple_lines
    description: Multiple $fwrite calls to same file
    files:
      - name: test.sv
        content: |
          module Test;
            int fd;
            initial begin
              fd = $fopen("output.txt", "w");
              $fwrite(fd, "line1");
              $fdisplay(fd);
              $fwrite(fd, "line2");
              $fdisplay(fd);
              $fclose(fd);
            end
          endmodule
    expect:
      files:
        output.txt: "line1\nline2\n"

  - name: mcd_stdout_and_file_verified
    description: MCD OR with stdout and file (both verified)
    files:
      - name: test.sv
        content: |
          module Test;
            int mcd;
            initial begin
              mcd = $fopen("log.txt");
              $fdisplay(1 | mcd, "dual output");
              $fclose(mcd);
            end
          endmodule
    expect:
      stdout: "dual output\n"
      files:
        log.txt: "dual output\n"
