load("@rules_cc//cc:defs.bzl", "cc_binary", "cc_library", "cc_test")
load("//tests:sv_feature_test.bzl", "sv_feature_test")

cc_library(
    name = "test_framework",
    srcs = ["framework/yaml_loader.cpp"],
    hdrs = [
        "framework/test_case.hpp",
        "framework/yaml_loader.hpp",
    ],
    deps = [
        "@yaml-cpp",
    ],
)

cc_library(
    name = "batch_compiler",
    srcs = ["framework/batch_compiler.cpp"],
    hdrs = ["framework/batch_compiler.hpp"],
    deps = [
        ":test_framework",
        "//:core",
        "@nlohmann_json//:json",
    ],
)

# CLI test framework
cc_library(
    name = "cli_test_fixture",
    srcs = ["cli/cli_test_fixture.cpp"],
    hdrs = ["cli/cli_test_fixture.hpp"],
    deps = [
        "//:core",
        "@googletest//:gtest",
    ],
)

cc_test(
    name = "cli_init_tests",
    srcs = ["cli/init_tests.cpp"],
    data = ["//:lyra"],
    env = {"TEST_WORKSPACE": "lyra"},
    deps = [
        ":cli_test_fixture",
        "@googletest//:gtest_main",
    ],
)

cc_test(
    name = "cli_config_tests",
    srcs = ["cli/config_tests.cpp"],
    data = ["//:lyra"],
    env = {"TEST_WORKSPACE": "lyra"},
    deps = [
        ":cli_test_fixture",
        "@googletest//:gtest_main",
    ],
)

cc_test(
    name = "cli_dump_tests",
    srcs = ["cli/dump_tests.cpp"],
    data = ["//:lyra"],
    env = {"TEST_WORKSPACE": "lyra"},
    deps = [
        ":cli_test_fixture",
        "@googletest//:gtest_main",
    ],
)

# SystemVerilog Feature Tests
#
# Run options:
#   bazel test //tests:sv_feature_tests              # All tests (CI uses this)
#   bazel test //tests:operators_binary_tests        # Single category (manual tag)
#   bazel test //tests:sv_feature_tests --test_arg=--gtest_filter='*addition*'

# Shared binary (built once, used by all wrappers)
cc_binary(
    name = "sv_feature_tests_bin",
    srcs = ["framework/sv_feature_tests.cpp"],
    data = glob(["sv_features/**/*.yaml"]) + ["//:embedded_headers"],
    deps = [
        "//:core",
        "//tests:batch_compiler",
        "//tests:test_framework",
        "@googletest//:gtest",
    ],
)

# Full test suite - no sharding because batch compilation amortizes C++ compile
# cost across all tests. With sharding, each shard redundantly compiles the
# full batch (~17s each), wasting CPU cycles with no wall-clock benefit.
cc_test(
    name = "sv_feature_tests",
    size = "large",
    srcs = ["framework/sv_feature_tests.cpp"],
    data = glob(["sv_features/**/*.yaml"]) + ["//:embedded_headers"],
    shard_count = 1,
    deps = [
        "//:core",
        "//tests:batch_compiler",
        "//tests:test_framework",
        "@googletest//:gtest",
    ],
)

# Individual category targets (thin wrappers around sv_feature_tests_bin)

# Operators
sv_feature_test(
    name = "operators_binary_tests",
    yaml = "sv_features/operators/binary.yaml",
)

sv_feature_test(
    name = "operators_unary_tests",
    yaml = "sv_features/operators/unary.yaml",
)

sv_feature_test(
    name = "operators_concat_tests",
    yaml = "sv_features/operators/concat.yaml",
)

sv_feature_test(
    name = "operators_replicate_tests",
    yaml = "sv_features/operators/replicate.yaml",
)

# Processes
sv_feature_test(
    name = "processes_initial_tests",
    yaml = "sv_features/processes/initial.yaml",
)

sv_feature_test(
    name = "processes_timing_tests",
    yaml = "sv_features/processes/timing.yaml",
)

sv_feature_test(
    name = "processes_non_blocking_tests",
    yaml = "sv_features/processes/non_blocking.yaml",
)

sv_feature_test(
    name = "processes_wait_event_tests",
    yaml = "sv_features/processes/wait_event.yaml",
)

# Control flow
sv_feature_test(
    name = "control_flow_conditionals_tests",
    yaml = "sv_features/control_flow/conditionals.yaml",
)

sv_feature_test(
    name = "control_flow_loops_tests",
    yaml = "sv_features/control_flow/loops.yaml",
)

sv_feature_test(
    name = "control_flow_case_tests",
    yaml = "sv_features/control_flow/case.yaml",
)

sv_feature_test(
    name = "control_flow_foreach_tests",
    yaml = "sv_features/control_flow/foreach.yaml",
)

sv_feature_test(
    name = "control_flow_unique_priority_case_tests",
    yaml = "sv_features/control_flow/unique_priority_case.yaml",
)

sv_feature_test(
    name = "control_flow_unique_priority_if_tests",
    yaml = "sv_features/control_flow/unique_priority_if.yaml",
)

# Datatypes
sv_feature_test(
    name = "datatypes_variables_tests",
    yaml = "sv_features/datatypes/variables.yaml",
)

sv_feature_test(
    name = "datatypes_real_types_tests",
    yaml = "sv_features/datatypes/real_types.yaml",
)

sv_feature_test(
    name = "datatypes_shortreal_types_tests",
    yaml = "sv_features/datatypes/shortreal_types.yaml",
)

sv_feature_test(
    name = "datatypes_realtime_types_tests",
    yaml = "sv_features/datatypes/realtime_types.yaml",
)

sv_feature_test(
    name = "datatypes_arrays_tests",
    yaml = "sv_features/datatypes/arrays.yaml",
)

sv_feature_test(
    name = "datatypes_dynamic_arrays_tests",
    yaml = "sv_features/datatypes/dynamic_arrays.yaml",
)

sv_feature_test(
    name = "datatypes_queues_tests",
    yaml = "sv_features/datatypes/queues.yaml",
)

sv_feature_test(
    name = "datatypes_arbitrary_width_tests",
    yaml = "sv_features/datatypes/arbitrary_width.yaml",
)

sv_feature_test(
    name = "datatypes_packed_2d_tests",
    yaml = "sv_features/datatypes/packed_2d.yaml",
)

sv_feature_test(
    name = "datatypes_indexed_part_select_tests",
    yaml = "sv_features/datatypes/indexed_part_select.yaml",
)

sv_feature_test(
    name = "datatypes_conversions_tests",
    yaml = "sv_features/datatypes/conversions.yaml",
)

sv_feature_test(
    name = "datatypes_wide_packed_2d_tests",
    yaml = "sv_features/datatypes/wide_packed_2d.yaml",
)

sv_feature_test(
    name = "datatypes_packed_3d_tests",
    yaml = "sv_features/datatypes/packed_3d.yaml",
)

sv_feature_test(
    name = "datatypes_unbased_unsized_literal_tests",
    yaml = "sv_features/datatypes/unbased_unsized_literal.yaml",
)

sv_feature_test(
    name = "datatypes_typedef_tests",
    yaml = "sv_features/datatypes/typedef.yaml",
)

sv_feature_test(
    name = "datatypes_packed_struct_tests",
    yaml = "sv_features/datatypes/packed_struct.yaml",
)

sv_feature_test(
    name = "datatypes_packed_union_tests",
    yaml = "sv_features/datatypes/packed_union.yaml",
)

sv_feature_test(
    name = "datatypes_unpacked_struct_tests",
    yaml = "sv_features/datatypes/unpacked_struct.yaml",
)

sv_feature_test(
    name = "datatypes_enum_tests",
    yaml = "sv_features/datatypes/enum.yaml",
)

sv_feature_test(
    name = "datatypes_enum_methods_tests",
    yaml = "sv_features/datatypes/enum_methods.yaml",
)

sv_feature_test(
    name = "datatypes_string_concat_tests",
    yaml = "sv_features/datatypes/string_concat.yaml",
)

sv_feature_test(
    name = "datatypes_math_tests",
    yaml = "sv_features/datatypes/math.yaml",
)

# Display
sv_feature_test(
    name = "display_basic_tests",
    yaml = "sv_features/display/basic.yaml",
)

sv_feature_test(
    name = "display_strobe_tests",
    yaml = "sv_features/display/strobe.yaml",
)

sv_feature_test(
    name = "display_monitor_tests",
    yaml = "sv_features/display/monitor.yaml",
)

# System tasks
sv_feature_test(
    name = "system_tasks_simulation_control_tests",
    yaml = "sv_features/system_tasks/simulation_control.yaml",
)

sv_feature_test(
    name = "system_tasks_time_functions_tests",
    yaml = "sv_features/system_tasks/time_functions.yaml",
)

sv_feature_test(
    name = "system_tasks_mem_io_tests",
    yaml = "sv_features/system_tasks/mem_io.yaml",
)

# Timing
sv_feature_test(
    name = "timing_timescale_tests",
    yaml = "sv_features/timing/timescale.yaml",
)

sv_feature_test(
    name = "timing_timeformat_tests",
    yaml = "sv_features/timing/timeformat.yaml",
)

sv_feature_test(
    name = "timing_timeunit_tests",
    yaml = "sv_features/timing/timeunit.yaml",
)

sv_feature_test(
    name = "timing_printtimescale_tests",
    yaml = "sv_features/timing/printtimescale.yaml",
)

# Hierarchy
sv_feature_test(
    name = "hierarchy_local_variables_tests",
    yaml = "sv_features/hierarchy/local_variables.yaml",
)

sv_feature_test(
    name = "hierarchy_nested_hierarchy_tests",
    yaml = "sv_features/hierarchy/nested_hierarchy.yaml",
)

sv_feature_test(
    name = "hierarchy_instantiation_tests",
    yaml = "sv_features/hierarchy/instantiation.yaml",
)

sv_feature_test(
    name = "hierarchy_multiple_instances_tests",
    yaml = "sv_features/hierarchy/multiple_instances.yaml",
)

sv_feature_test(
    name = "hierarchy_output_ports_tests",
    yaml = "sv_features/hierarchy/output_ports.yaml",
)

sv_feature_test(
    name = "hierarchy_port_expressions_tests",
    yaml = "sv_features/hierarchy/port_expressions.yaml",
)

sv_feature_test(
    name = "hierarchy_hierarchical_reads_tests",
    yaml = "sv_features/hierarchy/hierarchical_reads.yaml",
)

sv_feature_test(
    name = "hierarchy_hierarchical_sensitivity_tests",
    yaml = "sv_features/hierarchy/hierarchical_sensitivity.yaml",
)

# Scheduling
sv_feature_test(
    name = "scheduling_zero_delay_tests",
    yaml = "sv_features/scheduling/zero_delay.yaml",
)

sv_feature_test(
    name = "scheduling_nba_ordering_tests",
    yaml = "sv_features/scheduling/nba_ordering.yaml",
)

sv_feature_test(
    name = "scheduling_regions_tests",
    yaml = "sv_features/scheduling/regions.yaml",
)

# Functions
sv_feature_test(
    name = "functions_basic_tests",
    yaml = "sv_features/functions/basic.yaml",
)

sv_feature_test(
    name = "functions_recursion_tests",
    yaml = "sv_features/functions/recursion.yaml",
)

sv_feature_test(
    name = "functions_nested_calls_tests",
    yaml = "sv_features/functions/nested_calls.yaml",
)

# Packages
sv_feature_test(
    name = "packages_basic_tests",
    yaml = "sv_features/packages/basic.yaml",
)

# Constants
sv_feature_test(
    name = "packages_functions_tests",
    yaml = "sv_features/packages/functions.yaml",
)

sv_feature_test(
    name = "constants_parameters_tests",
    yaml = "sv_features/constants/parameters.yaml",
)

# Statements
sv_feature_test(
    name = "statements_continuous_assign_tests",
    yaml = "sv_features/statements/continuous_assign.yaml",
)

# Generate constructs (LRM ยง27)
sv_feature_test(
    name = "generate_generate_tests",
    yaml = "sv_features/generate/generate.yaml",
)
